import{hideOverlay,showOverlay}from"./shared.js";import{convertImgToCanvas,formattingDateTime,getDateTimeV2,idGenerator}from"./utils.js";let todoPriority=null,selectedTodo=null;function resetTodoForm(){document.getElementById("todo-form").reset()}function showTodoModal(){showOverlay(),document.getElementById("todo-modal").classList.remove("opacity-0","invisible")}function hideTodoModal(){hideOverlay(),hideTodoCoverPreview(),showTodoUploadLabel(),document.getElementById("todo-modal")?.classList.add("opacity-0","invisible")}function prepareCreateTodoModal(){document.getElementById("todo-form__update-todo-btn").classList.add("hidden"),document.getElementById("todo-modal__edit-todo-title").classList.add("hidden"),document.getElementById("todo-modal__new-todo-title").classList.remove("hidden"),document.getElementById("todo-form__create-todo-btn").classList.remove("hidden")}function showCreateTodoModal(){resetTodoForm(),document.getElementById("todo-form__date").value=formattingDateTime(getDateTimeV2()).dateTimeISO,prepareCreateTodoModal(),showTodoModal()}function preFillFromInputs(e){const{id:o,title:t,description:d,priority:n,cover:i,createdAt:a}=e;document.getElementById("todo-form__title").value=t,document.getElementById("todo-form__date").value=a,document.getElementById("todo-form__description").value=d,document.getElementById(`priority-${n.toLowerCase()}`).checked=!0,document.getElementById("todo-form__update-todo-btn").dataset.taskId=o;document.getElementById("todo-form__cover").previousElementSibling.children[0].src=i.img?i.img:`/Todo-list-website/public/assets/images/todoes/${i.path}`,showTodoCoverPreview(),hideTodoUploadLabel()}function prepareEditTodoModal(e){resetTodoForm(),preFillFromInputs(e),document.getElementById("todo-form__create-todo-btn").classList.add("hidden"),document.getElementById("todo-modal__new-todo-title").classList.add("hidden"),document.getElementById("todo-form__update-todo-btn").classList.remove("hidden"),document.getElementById("todo-modal__edit-todo-title").classList.remove("hidden")}function showEditTodoModal(e){selectedTodo=e,prepareEditTodoModal(e),showTodoModal()}function showTodoUploadLabel(){document.getElementById("todo-form__cover-upload-label")?.classList.remove("hidden")}function hideTodoUploadLabel(){document.getElementById("todo-form__cover-upload-label").classList.add("hidden")}function showTodoCoverPreviewHandler(e){const o=new FileReader,t=e.target.files[0],d=e.target.previousElementSibling;t&&(o.onload=e=>{d.children[0].src=e.target.result;const o=new Image;o.onload=()=>{convertImgToCanvas(o)},o.src=e.target.result},o.readAsDataURL(t)),showTodoCoverPreview(),hideTodoUploadLabel()}function showTodoCoverPreview(){document.getElementById("todo-form__cover-preview").classList.remove("hidden")}function hideTodoCoverPreview(){document.getElementById("todo-form__cover-preview")?.classList.add("hidden")}function generateNewTodo(e,o){return{id:e??idGenerator(),status:"not started",priority:document.querySelector(".priority-task:checked")?.dataset.taskPriority,cover:o??{path:"./default-todo-cover.png",alt:"default todo cover",type:"png",img:null},title:document.getElementById("todo-form__title").value.trim(),createdAt:document.getElementById("todo-form__date").value,description:document.getElementById("todo-form__description").value.trim()}}function createTodoHandler(e){e.preventDefault();const o=document.getElementById("todo-form__cover").files,t=generateNewTodo();if(isTodoValid(t)){if(o.length){const e=new FileReader;e.onload=e=>{const o=new Image;o.onload=()=>{t.cover.img=convertImgToCanvas(o),t.cover.alt=t.title,document.dispatchEvent(new CustomEvent("todoCreated",{detail:t}))},o.src=e.target.result},e.readAsDataURL(o[0])}else document.dispatchEvent(new CustomEvent("todoCreated",{detail:t}));hideTodoModal()}}function updateEditedTodo(e){const o=document.getElementById("todo-form__cover").files,t=generateNewTodo(e,selectedTodo.cover);if(isTodoValid(t)){if(o.length){const e=new FileReader;e.onload=e=>{const d=new Image;d.onload=()=>{t.cover.img=convertImgToCanvas(d),t.cover.alt=t.title,t.cover.type=o[0].type,document.dispatchEvent(new CustomEvent("todoUpdated",{detail:t}))},d.src=e.target.result},e.readAsDataURL(o[0])}else document.dispatchEvent(new CustomEvent("todoUpdated",{detail:t}));hideTodoModal()}}function updateTodoHandler(e){e.preventDefault();updateEditedTodo(e.currentTarget.dataset.taskId)}const updateTodoBtn=document.getElementById("todo-form__update-todo-btn");function isTodoValid({title:e,description:o,file:t,createdAt:d,priority:n}){e=e.trim(),o=o.trim();const i=e&&o&&d&&n,a=["image/png","image/jpg","image/jpeg","image/webp"].includes(t?.type),r=["high","medium","low"].includes(n),l=t?.size<=5e5;return null==i?(swal({title:"Please fill all fields",icon:"warning"}),!1):t&&null==l?(swal({title:"Cover must be maximum 500KB",icon:"warning"}),!1):t&&null==a?(swal({title:"Cover type must be one of (png, jpg, jpeg, webp)",icon:"warning"}),!1):null!=r||(swal({title:"Priority must be (High, Medium or low)",icon:"warning"}),!1)}function deSelectPriorityInputs(){[...document.getElementsByClassName("priority-task")].forEach((e=>e.checked=!1))}function selectTodoPriorityHandler(e){const o=e.target;"INPUT"===o.tagName&&o.checked?(deSelectPriorityInputs(),o.checked=!0,todoPriority=o.dataset.taskPriority):todoPriority=null}updateTodoBtn?.addEventListener("click",updateTodoHandler);const priorityTasksContainer=document.getElementById("todo-form__priority-container");priorityTasksContainer?.addEventListener("click",selectTodoPriorityHandler);const createTodoBtn=document.getElementById("todo-form__create-todo-btn");createTodoBtn?.addEventListener("click",createTodoHandler);const todoCoverInput=document.getElementById("todo-form__cover");todoCoverInput?.addEventListener("change",showTodoCoverPreviewHandler);const closeCreateTodoModalBtn=document.getElementById("todo-modal__close-btn");closeCreateTodoModalBtn?.addEventListener("click",hideTodoModal);export{showCreateTodoModal,showEditTodoModal,hideTodoModal};