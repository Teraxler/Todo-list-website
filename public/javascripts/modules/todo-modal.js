import{hideOverlay as e,showOverlay as o}from"./shared.js";import{convertImgToCanvas as t,formattingDateTime as d,getDateTime as i,idGenerator as l}from"./utils.js";let selectedTodo=null;function resetTodoForm(){document.getElementById("todo-form").reset()}function showTodoModal(){o(),document.getElementById("todo-modal").classList.remove("opacity-0","invisible")}function hideTodoModal(){e(),hideTodoCoverPreview(),showTodoUploadLabel(),document.getElementById("todo-modal")?.classList.add("opacity-0","invisible")}function prepareCreateTodoModal(){document.getElementById("todo-form__update-todo-btn").classList.add("hidden"),document.getElementById("todo-modal__edit-todo-title").classList.add("hidden"),document.getElementById("todo-modal__new-todo-title").classList.remove("hidden"),document.getElementById("todo-form__create-todo-btn").classList.remove("hidden")}function showCreateTodoModal(){resetTodoForm(),document.getElementById("todo-form__date").value=d(i()).iso,prepareCreateTodoModal(),showTodoModal()}function preFillFromInputs(e){let{id:o,title:t,description:d,priority:i,cover:l,createdAt:r}=e;document.getElementById("todo-form__title").value=t,document.getElementById("todo-form__date").value=r,document.getElementById(`priority-${i}`).checked=!0,document.getElementById("todo-form__description").value=d,document.getElementById("todo-form__update-todo-btn").dataset.taskId=o;let a=document.getElementById("todo-form__cover").previousElementSibling.children[0];a.src=l.img?l.img:`/public/assets/images/todoes/${l.path}`,showTodoCoverPreview(),hideTodoUploadLabel()}function prepareEditTodoModal(e){resetTodoForm(),preFillFromInputs(e),document.getElementById("todo-form__create-todo-btn").classList.add("hidden"),document.getElementById("todo-modal__new-todo-title").classList.add("hidden"),document.getElementById("todo-form__update-todo-btn").classList.remove("hidden"),document.getElementById("todo-modal__edit-todo-title").classList.remove("hidden")}function showEditTodoModal(e){selectedTodo=e,prepareEditTodoModal(e),showTodoModal()}function showTodoUploadLabel(){document.getElementById("todo-form__cover-upload-label")?.classList.remove("hidden")}function hideTodoUploadLabel(){document.getElementById("todo-form__cover-upload-label").classList.add("hidden")}function showTodoCoverPreviewHandler(e){let o=new FileReader,t=e.target.files[0],d=e.target.previousElementSibling;t&&(o.onload=e=>{d.children[0].src=e.target.result},o.readAsDataURL(t)),showTodoCoverPreview(),hideTodoUploadLabel()}function showTodoCoverPreview(){document.getElementById("todo-form__cover-preview")?.classList.remove("hidden")}function hideTodoCoverPreview(){document.getElementById("todo-form__cover-preview")?.classList.add("hidden")}function createTodo(e,o){return{id:e??l(),status:"not started",createdAt:document.getElementById("todo-form__date").value,title:document.getElementById("todo-form__title").value.trim(),description:document.getElementById("todo-form__description").value.trim(),priority:document.querySelector(".priority-task:checked")?.dataset.taskPriority,cover:o??{path:"./default-todo-cover.png",alt:"default todo cover",type:"png",img:null}}}async function convertImgToBase64(e){return new Promise((o,d)=>{let i={img:null,type:null,size:null},l=new FileReader;l.onload=d=>{let l=new Image;l.onload=()=>{i.img=t(l),i.type=e.type,i.type=e.size,o(i)},l.src=d.target.result},l.onerror=e=>d(Error(`Failed to read file ${e}`)),l.readAsDataURL(e)})}async function createTodoHandler(e){e.preventDefault();let o=document.getElementById("todo-form__cover").files[0],t=createTodo();if(isTodoValid(t)){if(o){let d=await convertImgToBase64(o);t.cover.img=d.img,t.cover.type=d.type,t.cover.alt=t.title}document.dispatchEvent(new CustomEvent("todoCreated",{detail:t})),hideTodoModal()}}async function updateTodoHandler(e){e.preventDefault();let o=document.getElementById("todo-form__cover").files[0],t=e.currentTarget.dataset.taskId,d=createTodo(t,selectedTodo.cover);if(isTodoValid(d)){if(o){let i=await convertImgToBase64(o);d.cover.img=i.img,d.cover.type=i.type}d.cover.alt=d.title,document.dispatchEvent(new CustomEvent("todoUpdated",{detail:d})),hideTodoModal()}}let updateTodoBtn=document.getElementById("todo-form__update-todo-btn");function isTodoValid({title:e,description:o,file:t,createdAt:d,priority:i}){e=e.trim(),o=o.trim();let l=e&&o&&d&&i,r=["image/png","image/jpg","image/jpeg","image/webp"].includes(t?.type),a=["high","medium","low"].includes(i),n=t?.size<=3e5;return l?t&&!n?(swal({title:"Cover must be maximum 300KB",icon:"warning"}),!1):t&&!r?(swal({title:"Cover type must be one of (png, jpg, jpeg, webp)",icon:"warning"}),!1):!!a||(swal({title:"Priority must be (High, Medium or low)",icon:"warning"}),!1):(swal({title:"Please fill all fields",icon:"warning"}),!1)}function deSelectPriorityInputs(){[...document.getElementsByClassName("priority-task")].forEach(e=>e.checked=!1)}function selectTodoPriorityHandler(e){let o=e.target;"INPUT"===o.tagName&&o.checked&&(deSelectPriorityInputs(),o.checked=!0)}updateTodoBtn?.addEventListener("click",updateTodoHandler);let priorityTasksContainer=document.getElementById("todo-form__priority-container");priorityTasksContainer?.addEventListener("click",selectTodoPriorityHandler);let createTodoBtn=document.getElementById("todo-form__create-todo-btn");createTodoBtn?.addEventListener("click",createTodoHandler);let todoCoverInput=document.getElementById("todo-form__cover");todoCoverInput?.addEventListener("change",showTodoCoverPreviewHandler);let closeCreateTodoModalBtn=document.getElementById("todo-modal__close-btn");closeCreateTodoModalBtn?.addEventListener("click",hideTodoModal);export{showCreateTodoModal,showEditTodoModal,hideTodoModal};